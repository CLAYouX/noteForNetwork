[TOC]

## 一、基础篇

### 1.1 TCP/IP 网络模型

对于同⼀台设备上的进程间通信，有很多种⽅式，⽐如有管道、消息队列、共享内存、信号等⽅式，⽽对于不同设
备上的进程间通信，就需要⽹络通信，⽽设备是多样性的，所以要兼容多种多样的设备，就协商出了⼀套 **通⽤的⽹络协议**。

这个⽹络协议是分层的，每⼀层都有各⾃的作⽤和职责。

#### 应用层

应⽤层只需要专注于为⽤户提供应⽤功能，不⽤去关⼼数据是如何传输的。

应⽤层是⼯作在操作系统中的 **⽤户态**，传输层及以下则⼯作在内核态。

#### 传输层

应⽤层的数据包会传给传输层，**传输层（Transport Layer）** 是为应⽤层提供⽹络⽀持的。

在传输层会有两个传输协议，分别是 **TCP** 和 **UDP**。

应⽤需要传输的数据可能会⾮常⼤，如果直接传输就不好控制，因此当传输层的数据包⼤⼩超过 **MSS（TCP 最⼤报⽂段⻓度）** ，就要将数据包分块，这样即使中途有⼀个分块丢失或损坏了，只需要重新这⼀个分块，⽽不⽤重新发送整个数据包。在 TCP 协议中，我们把每个分块称为⼀个 **TCP 段（TCP Segment）**，如下图所示：

![TCP分段.PNG](https://i.loli.net/2021/08/08/IS6iJurz5bw1Y2f.png)

当设备作为接收⽅时，传输层则要负责把数据包传给应⽤，但是⼀台设备上可能会有很多应⽤在接收或者传输数据，因此需要⽤⼀个编号将应⽤区分开来，这个编号就是 **端⼝**。

浏览器（客户端）中的每个标签栏都是⼀个 **独⽴的进程**，操作系统会为这些进程分配临时的端⼝号。

#### 网络层

我们不希望传输层协议处理太多的事情，只需要服务好应⽤即可，让其作为应⽤间数据传输的媒介，帮助实现应⽤到应⽤的通信，⽽实际的传输功能就交给下⼀层，也就是 **⽹络层（Internet Layer）**。

网络层最常使用的是 **IP协议（Internet Protocol）**，IP 协议会将传输层的报⽂作为数据部分，再加上 IP 包头组装成 IP 报⽂，如果 IP 报⽂⼤⼩超过 **最大传输单元MTU**（以太⽹中⼀般为 1500 字节），就会再次进⾏ **分⽚**，得到⼀个即将发送到⽹络的 IP 报⽂。

![IP报文.PNG](https://i.loli.net/2021/08/08/lPdOjzaUb5VNvTW.png)

⽹络层负责 **将数据从⼀个设备传输到另⼀个设备**。因此，⽹络层需要有区分设备的编号。

⼀般⽤ **IP 地址** 给设备进⾏编号，对于 IPv4 协议， IP 地址共 32 位，分成了四段，每段是 8 位。 IP 地址可以分成两种意义：

- 一个是 **网络号**，负责标识该 IP 地址属于哪个子网；
- 一个是 **主机号**，负责标识同一子网下的不同主机；

这需要配合 **子网掩码** 才能算出 IP 地址 的⽹络号和主机号。在寻址的过程中，先匹配到相同的⽹络号，再去找对应的主机。

除了寻址能⼒， IP 协议还有另⼀个重要的能⼒就是 **路由**。实际场景中，两台设备并不是⽤⼀条⽹线连接起来的，⽽是通过很多⽹关、路由器、交换机等众多⽹络设备连接起来的，那么就会形成很多条⽹络的路径。因此，当数据包到达⼀个⽹络节点，就需要通过算法决定下⼀步⾛哪条路径。

所以，**IP 协议的寻址作用是告诉我们去往下⼀个⽬的地该朝哪个⽅向⾛，路由则是根据「下⼀个⽬的地」选择路径**。寻址更像在导航，路由更像在操作⽅向盘。

#### 数据链路层

网络中由一个专⻔的层来标识⽹络中的设备，让数据在⼀个链路中传输，这就是 **数据链路层（Data Link Layer）**，它主要为⽹络层提供链路级别传输的服务。

每⼀台设备的⽹卡都会有⼀个 MAC 地址，⽤来唯⼀标识设备。路由器计算出了下⼀个⽬的地 IP 地址，再通过 **ARP 协议** 找到该⽬的地的 MAC 地址，这样就知道这个 IP 地址是哪个设备的了。

#### 物理层

当数据要从设备发送到⽹络时，需要把数据包转换成电信号，让其可以在物理介质中传输，这⼀层就是 **物理层（Physical Layer）**，它主要是为数据链路层提供⼆进制传输的服务。

## 二、HTTP篇

### 2.1 HTTP基本概念

HTTP 是 **超⽂本传输协议**。

HTTP 是⼀个⽤在计算机世界⾥的协议。它使⽤计算机能够理解的语⾔确⽴了⼀种计算机之间交流通信的规范（**两个以上的参与者**），以及相关的各种控制和错误处理⽅式（**⾏为约定和规范**）。

HTTP 是⼀个在计算机世界⾥专⻔⽤来在 **两点之间传输数据** 的约定和规范。

HTTP 是⼀个 **在计算机世界⾥专⻔在「两点」之间「传输」⽂字、图⽚、⾳频、视频等「超⽂本」数据的「约定和规范」**。

#### HTTP常见状态码

![HTTP状态码.PNG](https://i.loli.net/2021/08/08/ZtTljcFDWEIfRsk.png)

## 三、TCP篇

### 3.1 TCP基础

#### 1、TCP基本认识

##### TCP 头部格式：

![TCP头.PNG](https://i.loli.net/2021/08/08/dOaiqwT1MfmknV9.png)

**序列号SYN**：在建⽴连接时由计算机⽣成的随机数作为其初始值，通过 SYN 包传给接收端主机，每发送⼀次数据，就「累加」⼀次该「数据字节数」的⼤⼩。⽤来 **解决⽹络包乱序问题**。

**确认应答号ACK**：指下⼀次 **期望收到的数据的序列号**，发送端收到这个确认应答以后可以认为在这个序号以前的数据都已经被正常接收。⽤来 **解决不丢包的问题**。

**控制位**：

- `ACK`：该位为 1 时，「确认应答」的字段变为有效，TCP 规定除了最初建⽴连接时的 SYN 包之外该位必须设置为 1；
- `RST`：该位为 1 时，表示 TCP 连接中 **出现异常必须强制断开连接**；
- `SYN`：该位为 1 时，表示 **希望建⽴连接**，并在其「序列号」的字段进⾏序列号初始值的设定；
- `FIN`：该位为 1 时，表示今后不会再有数据发送，**希望断开连接**。

##### 为什么需要 TCP 协议

IP 层是 **不可靠** 的，它不保证⽹络包的交付、不保证⽹络包的按序交付、也不保证⽹络包中的数据的完整性。

如果需要 **保障⽹络数据包的可靠性**，那么就需要由上层（传输层）的 TCP 协议来负责。

因为 TCP 是⼀个⼯作在 **传输层的可靠数据传输的服务**，它能确保接收端接收的⽹络包是 **⽆损坏、⽆间隔、⾮冗余和按序的**。

##### 什么是 TCP

TCP 是 **⾯向连接的、可靠的、基于字节流** 的传输层通信协议。

- 面向连接：**一对一**才能连接，不能像 UDP 协议可以一个主机同时向多个主机发送消息；
- 可靠的：⽆论的⽹络链路中出现了怎样的链路变化，TCP 都可以保证⼀个报⽂⼀定能够到达接收端；
- 字节流：消息是「没有边界」的，所以⽆论我们消息有多⼤都可以进⾏传输。并且消息是「有序的」，当「前⼀个」消息没有收到的时候，即使它先收到了后⾯的字节，那么也不能扔给应⽤层去处理，同时对「重复」的报⽂会⾃动丢弃。

##### 什么是 TCP 连接

⽤于保证可靠性和流量控制维护的某些状态信息，这些信息的组合，包括 **Socket、序列号和窗⼝⼤⼩** 称为连接。

因此，建⽴⼀个 TCP 连接是需要客户端与服务器端达成上述三个信息的共识：

- **Socket**：由 IP 地址和端口号组成；
- **序列号**：用来解决乱序问题；
- **窗口大小**：用来实现流量控制。

##### 唯一地确定一个 TCP 连接

TCP 四元组可以唯⼀的确定⼀个连接，四元组包括：**源地址、源端口、目的地址、目的端口**。

- 源地址和目的地址的字段（32位）在 **IP 头部** 中，作用是通过 IP 协议发送报文给对方主机；

- 源端口和目的端口的字段（16位）在 **TCP头部** 中，作用是告诉 TCP 协议应该把报文发送给哪个进程。

##### 有一个 IP 的服务器监听了一个端口，它的 TCP 最大连接数是多少

服务器通常固定在某个本地端口上监听，等待客户端的连接请求。

因此，客户端 IP 和 端口是可变的，其理论值计算公式如下：
$$
Maxmum_{TCP}=IP_{client}*Port_{client}
$$
对于 $IPv4$，客户端的 IP 数最多为 $2^{32}$，客户端的端口数最多为 $2^{16}$，即服务器的最大 TCP 连接数，约为 $2^{48}$。

当然，实际场景中，服务端的最大并发 TCP 连接数远不能达到理论上限。

- 首先主要是 **文件描述符限制**，Socket 都是文件，所有要通过 `ulimit` 配置文件描述符的数目；
- 其次是 `内存限制`，每个 TCP 连接都要占用一定的内存，而操作系统的内存是有限的。

##### UDP 和 TCP 的区别和各自应用场景

UDP 不提供复杂的控制机制，利⽤ IP 提供 **⾯向⽆连接的通信服务**。

UDP 头部如下：

![UDP头.PNG](https://i.loli.net/2021/08/08/AxQ4BeDORGzburE.png)

TCP 和 UDP 区别：

1. 连接：
   - TCP 是 **面向连接** 的传输层协议，传输数据前先要建立连接。
   - UDP 是 **面向无连接** 
2. 服务对象
   - TCP 是 **一对一的两点服务**
   - UDP 则支持 一对一、一对多、多对多的交互通信
3. 可靠性：
   - TCP 是**可靠交付数据** 的，数据可以无差错、不丢失、不重复、按需到达；
   - UDP 则是尽最大努力交付，不保证可靠交付数据
4. 拥塞控制、流量控制：
   - TCP **有拥塞控制和流量控制机制**，保证数据传输的安全性；
   - UDP 则没有，即使网络非常拥堵了，也不会影响 UDP 的发送速率。
5. 首部开销：
   - TCP 首部长度较长，会有一定的开销，首部在没有使用 `选项` 字段时是 ==20 字节==，如果使用了 `选项` 字段，则会更长；
   - UDP 首部只有 ==8 字节==，并且是固定不变的，开销较小。
6. 传输方式：
   - TCP 是 **流式传输**，没有边界，但保证顺序和可靠；
   - UDP 是一个包一个包的发送，是有边界的，但可能会丢包和乱序。
7. 分片不同：
   - TCP 的数据⼤⼩如果 **⼤于 MSS **，则会 **在传输层进⾏分⽚**，⽬标主机收到后，也同样 **在传输层组装 TCP数据包**，如果中途丢失了⼀个分⽚，只需要传输丢失的这个分⽚；
   - UDP 的数据⼤⼩如果 **⼤于 MTU **，则会 **在 IP 层进⾏分⽚**，⽬标主机收到后，在 **IP 层组装完数据**，接着再传给传输层，但是如果中途丢了⼀个分⽚，在实现可靠传输的 UDP 时则就需要 **重传所有的数据包**，这样传输效率⾮常差，所以通常 UDP 的报⽂应该⼩于 MTU。

